<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ECharts Visualization</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.3.0/dist/echarts.min.js"></script>
</head>
<body>
    <!-- 柱状图的容器 -->
    <div id="barChart" style="width: 600px;height:400px;"></div>
    <!-- 饼图的容器 -->
    <div id="pieChart" style="width: 600px;height:400px;"></div>
    <!-- 折线图的容器 -->
    <div id="lineChart" style="width: 600px;height:400px;"></div>
    <!-- 组合双Y轴柱状图容器 -->
    <div id="dualBarChart" style="width: 800px;height:500px;"></div>
    <!-- 全局大学排名热力图 -->
    <div id="heatmapChart" style="width: 800px;height:500px;"></div>

    <script>
        // 异步加载CSV文件数据
        async function loadData() {
            const response = await fetch('data.csv'); // 将此路径替换为实际数据集路径
            const csvText = await response.text(); // 读取CSV文本内容
            const rows = csvText.split('\n').map(row => row.split(',')); // 按行拆分CSV数据
            const headers = rows[0]; // CSV的第一行是表头
            
            // 数据行过滤空值，并检查有效分数
            const data = rows.slice(1).filter(row => 
                row.length >= 5 && row[1] && !isNaN(parseFloat(row[4]))
            ); 
            
            console.log("Filtered Data:", data); // 调试：输出过滤后的数据

            // 提取数据列：高校名称、评分、地理位置和排名
            const institutions = data.map(row => row[1]); // 第2列：高校名称
            const scores = data.map(row => parseFloat(row[4])); // 第5列：综合评分
            const locations = data.map(row => row[3]); // 第4列：大洲位置
            const rankings = data.map(row => row[0]); // 第1列：排名
            
            console.log("Institutions:", institutions); // 调试：输出高校名称
            console.log("Scores:", scores); // 调试：输出分数

            // 调用函数渲染图表
            renderCharts(institutions, scores, locations, rankings);
        }

        // 渲染图表的函数
        function renderCharts(institutions, scores, locations, rankings) {
            // ----- 柱状图 -----
            var barChart = echarts.init(document.getElementById('barChart'));
            var barOption = {
                title: { text: '高校综合评分柱状图' },
                tooltip: { trigger: 'axis' },
                xAxis: {
                    type: 'category',
                    data: institutions,
                    axisLabel: {
                        interval: 0,
                        rotate: 30,
                        formatter: function(value) {
                            return value.length > 10 ? value.substring(0, 10) + '...' : value;
                        }
                    }
                },
                yAxis: { type: 'value' },
                series: [{
                    data: scores,
                    type: 'bar',
                    barWidth: '60%'
                }]
            };
            barChart.setOption(barOption);

            // ----- 饼图 -----
            var pieChart = echarts.init(document.getElementById('pieChart'));
            var locationCounts = {};
            locations.forEach(loc => locationCounts[loc] = (locationCounts[loc] || 0) + 1);
            var pieData = Object.keys(locationCounts).map(loc => ({ name: loc, value: locationCounts[loc] }));

            var pieOption = {
                title: { text: '高校分布饼图' },
                series: [{ type: 'pie', data: pieData }]
            };
            pieChart.setOption(pieOption);

            // ----- 折线图 -----
            var lineChart = echarts.init(document.getElementById('lineChart'));
            var lineOption = {
                title: { text: '高校排名与评分折线图' },
                xAxis: {
                    type: 'category',
                    data: rankings.map(r => '排名 ' + r)
                },
                yAxis: { type: 'value', name: '评分' },
                series: [{
                    data: scores,
                    type: 'line',
                    smooth: true
                }]
            };
            lineChart.setOption(lineOption);

            // ----- 组合双Y轴柱状图 -----
            var dualBarChart = echarts.init(document.getElementById('dualBarChart'));
            var universityCounts = {};
            locations.forEach(loc => universityCounts[loc] = (universityCounts[loc] || 0) + 1);
            const avgScores = locations.map((loc, index) => ({ name: loc, score: scores[index] }));
            const countries = Array.from(new Set(locations));
            const countryCounts = countries.map(country => universityCounts[country]);
            const avgScorePerCountry = countries.map(country => {
                const countryScores = avgScores.filter(item => item.name === country).map(item => item.score);
                return countryScores.reduce((a, b) => a + b, 0) / countryScores.length;
            });

            var dualBarOption = {
                title: { text: '全球大学排名双Y轴可视化' },
                tooltip: { trigger: 'axis' },
                legend: { data: ['大学数量', '平均排名分数'] },
                xAxis: [{ type: 'category', data: countries }],
                yAxis: [{ type: 'value', name: '大学数量' }, { type: 'value', name: '平均排名分数' }],
                series: [{ name: '大学数量', type: 'bar', data: countryCounts }, { name: '平均排名分数', type: 'bar', yAxisIndex: 1, data: avgScorePerCountry }]
            };
            dualBarChart.setOption(dualBarOption);

            // ----- 热力图 -----
            var heatmapChart = echarts.init(document.getElementById('heatmapChart'));
            var heatmapOption = {
                title: { text: '全球大学排名热力图' },
                xAxis: { type: 'category', data: countries },
                yAxis: { type: 'category', data: ['大学数量', '平均排名分数'] },
                visualMap: { min: 0, max: 100, calculable: true, orient: 'vertical', left: 'right' },
                series: [{
                    name: '热力图',
                    type: 'heatmap',
                    data: countries.map((country, index) => [index, 0, countryCounts[index]]).concat(
                          countries.map((country, index) => [index, 1, avgScorePerCountry[index]])),
                    label: { show: true }
                }]
            };
            heatmapChart.setOption(heatmapOption);
        }

        // 加载数据并渲染图表
        loadData();
    </script>
</body>
</html>
